#include <GL/gl.h>
#include <stdlib.h>
#include <fcntl.h>
#include <unistd.h>
#include <assert.h>

#include "noise.h"

static const unsigned char g_cTexture[] =
{
	174,128,100,
	176,130,100,
	178,132,100,
	180,134,100,
	182,136,100,
	184,138,100,
	186,140,100,
	188,142,100,
	190,144,100,
	192,146,100,
	194,148,100,
	196,150,100,
	198,152,100,
	200,154,100,
	202,156,100,
	204,158,100,
	206,160,100,
	208,162,100,
	210,164,100,
	212,166,100,
	214,168,100,
	216,170,100,
	218,172,100,
	220,174,100,
	222,176,100,
	199,172,119,
	196,169,116,
	193,166,112,
	191,163,109,
	188,160,105,
	185,156,102,
	183,153,98,
	180,150,95,
	177,147,91,
	175,144,88,
	172,140,84,
	169,137,81,
	166,134,77,
	164,131,74,
	161,128,70,
	158,124,67,
	156,121,63,
	153,118,60,
	150,115,56,
	148,112,53,
	146,111,53,
	143,110,52,
	141,109,52,
	139,108,51,
	137,107,51,
	135,106,50,
	132,105,50,
	130,103,49,
	128,102,49,
	126,101,48,
	123,100,47,
	121,99,47,
	119,98,47,
	117,97,46,
	115,96,46,
	112,95,45,
	110,94,45,
	108,93,44,
	106,91,44,
	103,90,43,
	101,89,43,
	99,88,42,
	97,87,42,
	95,86,41,
	92,85,41,
	90,84,40,
	88,83,40,
	86,82,39,
	84,81,39,
	83,80,38,
	81,80,38,
	80,79,38,
	79,78,37,
	77,77,37,
	76,77,37,
	74,76,36,
	73,75,36,
	71,74,36,
	70,74,35,
	68,73,35,
	67,72,35,
	66,71,34,
	64,71,34,
	63,70,34,
	61,69,33,
	60,68,33,
	58,68,32,
	57,67,32,
	55,66,32,
	54,65,31,
	53,65,31,
	51,64,31,
	50,63,30,
	48,62,30,
	47,62,30,
	45,61,29,
	44,60,29,
	42,59,29,
	41,59,28,
	40,58,28,
	38,57,28,
	37,56,27,
	35,56,27,
	34,55,26,
	32,54,26,
	31,53,26,
	29,53,25,
	28,52,25,
	27,51,25,
	25,50,24,
	24,50,24,
	22,49,24,
	21,48,23,
	19,47,23,
	19,47,23,
	19,47,23,
	19,47,23,
	19,47,24,
	19,47,24,
	19,47,24,
	20,47,25,
	20,47,25,
	20,47,25,
	20,47,26,
	20,47,26,
	20,47,26,
	21,47,27,
	21,47,27,
	21,47,27,
	21,47,28,
	21,47,28,
	21,47,28,
	21,47,28,
	21,47,28,
	21,48,28,
	21,48,28,
	21,48,28,
	21,48,28,
	21,49,28,
	21,49,28,
	21,49,28,
	21,49,28,
	21,50,28,
	21,50,28,
	21,50,28,
	21,50,28,
	21,51,28,
	23,52,30,
	26,53,32,
	28,54,34,
	31,55,37,
	34,56,39,
	36,57,41,
	39,58,43,
	41,59,46,
	44,60,48,
	47,61,50,
	49,62,53,
	52,63,55,
	54,64,57,
	57,65,59,
	60,66,62,
	62,67,64,
	62,68,64,
	61,69,63,
	60,69,62,
	59,69,61,
	59,70,60,
	58,70,60,
	58,70,60,
	58,70,60,
	57,70,59,
	57,70,57,
	56,70,56,
	55,70,55,
	54,70,54,
	53,68,53,
	52,66,52,
	51,64,51,
	50,62,50,
	49,60,49,
	48,58,48,
	47,56,47,
	46,65,46,
	50,64,50,
	54,66,54,
	58,67,58,
	62,68,62,
	64,69,64,
	80,84,76,
	97,97,96,
	105,100,99,
	120,113,112,
	130,125,125,
	144,138,138,
	153,151,151,
	165,164,164,
	177,177,177,
	196,196,196,
	216,216,216,
	235,235,235,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255,
	255,255,255
};

static float clamp(float min, float max, float x)
{
	if (x < min)
		x = min;

	if (x > max)
		x = max;

	return x;
}

GLuint buildtexture(float fVariance)
{
	GLuint texid;

	struct color
	{
		float r, g, b, a;
	};
	static const struct color fOcean[] =
	{
		{0.0f, 0.0f, 0.29f},
		{0.0f, 0.02f, 0.35f},
		{0.0f, 0.05f, 0.39f},
		{0.0f, 0.07f, 0.44f},
		{0.01f, 0.09f, 0.49f},
		{0.01f, 0.14f, 0.55f},
		{0.02f, 0.25f, 0.65f},
	};
	static const struct color fLand[10] =
	{
		{0.5f, 0.39f, 0.2f},
		{0.2f, 0.3f, 0.0f},
		{0.085f, 0.2f, 0.04f},
		{0.065f, 0.22f, 0.04f},
		{0.5f, 0.42f, 0.28f},
		{0.6f, 0.5f, 0.23f},
		{1.0f, 1.0f, 1.0f},
		{1.0f, 1.0f, 1.0f},
		{1.0f, 1.0f, 1.0f},
		{1.0f, 1.0f, 1.0f}
	};

#define HALF_RAND		(RAND_MAX>>1)
#define TEXTURE_SIZE	256

	unsigned char pixels[TEXTURE_SIZE * TEXTURE_SIZE * 3];
	struct fractal *frac;

	frac = fractal_create(2, 12382, 1.f - (8. / 255), 2.25);

	glGenTextures(1, &texid);

	int n = 0;
	float fLattitude = 0;
	for(int i=0; i<TEXTURE_SIZE; i++) {
		float fAltitude = -fVariance;

		for(int j=0; j<TEXTURE_SIZE; j++) {
			float v[2] = { (float)j / TEXTURE_SIZE, (float)i / TEXTURE_SIZE };
			float d = clamp(0, 255, 250 + fractal_fBm(frac, v, 4) * 255 * .8);

			if(fAltitude < 0) {
				if(fLattitude > 75.0f) {
					pixels[n++] = d;
					pixels[n++] = d;
					pixels[n++] = 255;
				} else {
					float f = (1.0f - fAltitude / -fVariance) * 6.0f;

					int nWhole = (int)f;
					f -= (float)nWhole;

					pixels[n++] = (255.0f * (fOcean[nWhole].r * (1-f) + fOcean[nWhole+1].r * f));
					pixels[n++] = (255.0f * (fOcean[nWhole].g * (1-f) + fOcean[nWhole+1].g * f));
					pixels[n++] = (255.0f * (fOcean[nWhole].b * (1-f) + fOcean[nWhole+1].b * f));
				}
			} else {
				int a = clamp(0, 255, i + 255*fAltitude/fVariance);
				unsigned char r,g,b;

				r = g_cTexture[a*3 + 0];
				g = g_cTexture[a*3 + 1];
				b = g_cTexture[a*3 + 2];

				if (r > 250 && g > 250 && b > 250) {
					r = d;
					g = d;
				}

				pixels[n++] = (255.0f * clamp(0, 1, r / 255.0f + (rand()-HALF_RAND)/(RAND_MAX*50.0f)));
				pixels[n++] = (255.0f * clamp(0, 1, g / 255.0f + (rand()-HALF_RAND)/(RAND_MAX*50.0f)));
				pixels[n++] = (255.0f * clamp(0, 1, b / 255.0f + (rand()-HALF_RAND)/(RAND_MAX*50.0f)));
			}
			fAltitude += fVariance * 2.0f / TEXTURE_SIZE;
		}
		fLattitude += 90.0f / TEXTURE_SIZE;
	}

	free(frac);
	assert(n == sizeof(pixels));

	glBindTexture(GL_TEXTURE_2D, texid);
	glTexImage2D(GL_TEXTURE_2D, 0, GL_RGB, TEXTURE_SIZE, TEXTURE_SIZE,
		     0, GL_RGB, GL_UNSIGNED_BYTE, pixels);

	if (1) {
		int fd = open("tex.rgb", O_WRONLY|O_TRUNC|O_CREAT, 0600);
		write(fd, pixels, sizeof(pixels));
		close(fd);
	}

	return texid;
}
